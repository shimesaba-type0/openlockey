{% extends "base.html" %}

{% block title %}ダッシュボード - OpenLockey{% endblock %}

{% block header %}ダッシュボード{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- アカウント情報カード -->
        <div class="col-md-6 mb-4">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="card-title mb-0"><i class="bi bi-person-circle me-2"></i>アカウント情報</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <strong>ユーザー名:</strong> 
                        <span>{{ user.username }}</span>
                    </div>
                    <div class="mb-3">
                        <strong>アカウント作成日:</strong> 
                        <span>{{ user.created_at.strftime('%Y年%m月%d日') }}</span>
                    </div>
                    <div class="mb-3">
                        <strong>最終ログイン:</strong> 
                        <span>
                            {{ user.last_login.strftime('%Y年%m月%d日 %H:%M') if user.last_login else '情報なし' }}
                        </span>
                    </div>
                    <div class="mb-3">
                        <strong>アカウント状態:</strong> 
                        {% if user.is_active %}
                            <span class="badge bg-success">アクティブ</span>
                        {% else %}
                            <span class="badge bg-danger">無効</span>
                        {% endif %}
                    </div>
                    {% if user.is_admin %}
                        <div class="mb-3">
                            <span class="badge bg-primary">管理者</span>
                        </div>
                    {% endif %}
                </div>
                <div class="card-footer">
                    <a 
                        href="/dashboard/security" 
                        class="btn btn-sm btn-outline-primary"
                    >
                        <i class="bi bi-shield-lock me-1"></i>セキュリティ設定
                    </a>
                </div>
            </div>
        </div>
        
        <!-- アクティブセッションカード -->
        <div class="col-md-6 mb-4">
            <div class="card h-100">
                <div 
                    class="card-header d-flex justify-content-between align-items-center"
                >
                    <h5 class="card-title mb-0"><i class="bi bi-display me-2"></i>アクティブセッション</h5>
                    <button 
                        class="btn btn-sm btn-outline-danger" 
                        id="logoutAllBtn"
                    >
                        <i class="bi bi-box-arrow-right me-1"></i>全てのセッションを終了
                    </button>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>デバイス</th>
                                    <th>IPアドレス</th>
                                    <th>ログイン日時</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for session in sessions %}
                                <tr>
                                    <td>
                                        <i class="bi bi-{{ 
                                            'laptop' if 'Windows' in session.user_agent or 'Mac' in session.user_agent 
                                            else 'phone' if 'Mobile' in session.user_agent or 'Android' in session.user_agent 
                                            else 'display' 
                                        }}"></i>
                                        {{ 
                                            session.user_agent.split(')')[0] + ')' 
                                            if ')' in session.user_agent else session.user_agent 
                                        }}
                                    </td>
                                    <td>{{ session.ip_address }}</td>
                                    <td>{{ session.created_at.strftime('%Y/%m/%d %H:%M') }}</td>
                                    <td>
                                        {% if session.id == current_session_id %}
                                            <span class="badge bg-info">現在のセッション</span>
                                        {% else %}
                                            <button 
                                                class="btn btn-sm btn-outline-danger logout-session-btn" 
                                                data-session-id="{{ session.id }}"
                                            >
                                                <i class="bi bi-x-circle"></i>
                                            </button>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 最近のログイン履歴カード -->
        <div class="col-md-12 mb-4">
            <div class="card">
                <div 
                    class="card-header d-flex justify-content-between align-items-center"
                >
                    <h5 class="card-title mb-0"><i class="bi bi-clock-history me-2"></i>最近のログイン履歴</h5>
                    <a 
                        href="/dashboard/history" 
                        class="btn btn-sm btn-outline-secondary"
                    >
                        全ての履歴を表示
                    </a>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>日時</th>
                                    <th>IPアドレス</th>
                                    <th>デバイス</th>
                                    <th>ステータス</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for log in login_history %}
                                <tr>
                                    <td>{{ log.timestamp.strftime('%Y/%m/%d %H:%M:%S') }}</td>
                                    <td>{{ log.ip_address }}</td>
                                    <td>
                                        <i class="bi bi-{{ 
                                            'laptop' if 'Windows' in log.user_agent or 'Mac' in log.user_agent 
                                            else 'phone' if 'Mobile' in log.user_agent or 'Android' in log.user_agent 
                                            else 'display' 
                                        }}"></i>
                                        {{ 
                                            log.user_agent.split(')')[0] + ')' 
                                            if ')' in log.user_agent else log.user_agent 
                                        }}
                                    </td>
                                    <td>
                                        {% if log.success %}
                                            <span class="badge bg-success">成功</span>
                                        {% else %}
                                            <span 
                                                class="badge bg-danger" 
                                                data-bs-toggle="tooltip" 
                                                title="{{ log.failure_reason }}"
                                            >失敗</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // ツールチップの初期化
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
        
        // 単一セッションのログアウト
        const logoutSessionBtns = document.querySelectorAll('.logout-session-btn');
        logoutSessionBtns.forEach(btn => {
            btn.addEventListener('click', async function() {
                const sessionId = this.getAttribute('data-session-id');
                
                if (confirm('このセッションを終了してもよろしいですか？')) {
                    try {
                        const response = await fetch(`/api/user/sessions/${sessionId}`, {
                            method: 'DELETE',
                            headers: {
                                'Content-Type': 'application/json',
                            }
                        });
                        
                        if (response.ok) {
                            // セッション終了成功
                            const alertsDiv = document.getElementById('alerts');
                            alertsDiv.innerHTML = `
                                <div class="alert alert-success alert-dismissible fade show" role="alert">
                                    セッションが正常に終了しました。
                                    <button 
                                        type="button" 
                                        class="btn-close" 
                                        data-bs-dismiss="alert" 
                                        aria-label="Close"
                                    ></button>
                                </div>
                            `;
                            
                            // ページをリロード
                            setTimeout(() => {
                                window.location.reload();
                            }, 1500);
                        } else {
                            const data = await response.json();
                            throw new Error(data.detail || 'セッション終了に失敗しました。');
                        }
                    } catch (error) {
                        console.error('Session logout error:', error);
                        const alertsDiv = document.getElementById('alerts');
                        alertsDiv.innerHTML = `
                            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                                ${error.message || 'セッション終了中にエラーが発生しました。'}
                                <button 
                                    type="button" 
                                    class="btn-close" 
                                    data-bs-dismiss="alert" 
                                    aria-label="Close"
                                ></button>
                            </div>
                        `;
                    }
                }
            });
        });
        
        // 全セッションのログアウト
        const logoutAllBtn = document.getElementById('logoutAllBtn');
        logoutAllBtn.addEventListener('click', async function() {
            if (confirm('現在のセッションを含む全てのセッションを終了してもよろしいですか？\n' + 
                       'この操作を行うと、全てのデバイスからログアウトされます。')) {
                try {
                    const response = await fetch('/api/user/sessions', {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    });
                    
                    if (response.ok) {
                        // 全セッション終了成功
                        const alertsDiv = document.getElementById('alerts');
                        alertsDiv.innerHTML = `
                            <div class="alert alert-success alert-dismissible fade show" role="alert">
                                全てのセッションが正常に終了しました。ログインページにリダイレクトします。
                                <button 
                                    type="button" 
                                    class="btn-close" 
                                    data-bs-dismiss="alert" 
                                    aria-label="Close"
                                ></button>
                            </div>
                        `;
                        
                        // ログインページにリダイレクト
                        setTimeout(() => {
                            window.location.href = '/';
                        }, 2000);
                    } else {
                        const data = await response.json();
                        throw new Error(data.detail || '全セッション終了に失敗しました。');
                    }
                } catch (error) {
                    console.error('All sessions logout error:', error);
                    const alertsDiv = document.getElementById('alerts');
                    alertsDiv.innerHTML = `
                        <div class="alert alert-danger alert-dismissible fade show" role="alert">
                            ${error.message || '全セッション終了中にエラーが発生しました。'}
                            <button 
                                type="button" 
                                class="btn-close" 
                                data-bs-dismiss="alert" 
                                aria-label="Close"
                            ></button>
                        </div>
                    `;
                }
            }
        });
    });
</script>
{% endblock %}

